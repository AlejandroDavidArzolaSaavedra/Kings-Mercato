<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mercato Kings - MVP Partido</title>
  <meta name="description" content="Estadísticas de MVP por partido en la Kings League Mercato. Análisis de jugadores más valiosos por jornada.">
  <meta name="keywords" content="Kings League, Mercato, MVP, jugadores, fútbol, estadísticas">
  <meta name="author" content="Alejandro David Arzola Saavedra">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  <style>
    .card-tilted {
      transform: rotateX(75deg) translateY(-50px) translateZ(-50px);
      transition: transform 0.6s, box-shadow 0.6s;
    }
    .card-tilted:hover {
      transform: rotateX(0deg);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    @keyframes shine {
      0% { transform: translateX(-100%) rotate(1deg); }
      100% { transform: translateX(100%) rotate(1deg); }
    }
    .shine-effect::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 150%;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.6), transparent 70%);
      transform: translateX(-100%) rotate(12deg);
      animation: shine 2s linear infinite;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .card-tilted:hover .shine-effect::before {
      opacity: 1;
    }
    #tooltip {
      pointer-events: none;
      white-space: normal;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    #dashboard > div {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      border: 1px solid rgba(229, 231, 235, 0.8);
    }
    #dashboard > div:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(6, 8, 8, 0.466), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .mvp-badge {
      background-color: gold;
      color: #333;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      margin-left: 4px;
    }
    .ai-section {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      border-left: 4px solid #8E0303;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">

    
    <!-- Header con logo y título -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
      <a href="../index.html">
        <div class="flex items-center gap-3">
          <img src="../assets/kingsIA.svg" alt="Logo Kings League" style="width: 6rem">
          <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r" style="color: #8E0303;">
            MVP de Partido <span class="block text-xl text-gray-600">Kings League Mercato</span>
          </h1>
        </div>
      </a>
      
      <div class="flex items-center gap-2">
        <div class="flex gap-2 flex-wrap justify-center">
          <button onclick="loadYear('2023')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            2023
          </button>
          <button onclick="loadYear('2024')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            2024
          </button>
          <button onclick="loadYear('combined')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Combinado
          </button>
          <button onclick="loadYear('splits-only')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Solo Splits
          </button>
        </div>
      </div>
    </header>

    <!-- Loading spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
      <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
        <div class="flex items-center gap-4 mb-4">
          <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
          <div>
            <p class="text-lg font-semibold text-gray-800">Procesando datos...</p>
            <p class="text-sm text-gray-500" id="loadingText">Cargando archivos de estadísticas</p>
          </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
        <div class="mt-2 flex justify-between text-xs text-gray-500">
          <span id="progressText">0%</span>
          <span id="fileCount">0/0 archivos</span>
        </div>
      </div>
    </div>

    <!-- Navegación -->
        <nav class="flex gap-2 flex-wrap justify-center mb-4">
  <a href="./goals.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    Goles
  </a>
  <a href="./shots.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
    </svg>
    Tiros
  </a>
  <a href="./passing.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Pases
  </a>
  <a href="./offensives.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Ofensivas
  </a>
  <a href="./defensives.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Defensivas
  </a>
  <a href="./cards.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Tarjetas
  </a>
  <a href="./match_MVP.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    MVP Partido
  </a>
  <a href="./top_goal_keeper.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Portero
  </a>
</nav>

<audio id="miAudio" src="../assets/mvp.mp3"></audio>


        <!-- Añadimos imagen de portada-->
    <div class="relative w-full mb-8 cursor-pointer" onclick="document.getElementById('miAudio').play()" style="justify-content: center;">
      <img src="../assets/portada_mvp.png" alt="Kings League" class="w-full h-112 rounded-lg shadow-lg">
      <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-50"></div>
      <h2 class="absolute top-4 left-4 text-white text-2xl font-bold">Estadísticas de MVP - Kings League Mercato</h2>
    </div>
<div class="mt-4 mb-8" style="display: inline-block;">
  <p class="text-lg text-gray-500">
    Esta plataforma recopila datos desde la 
    <a href="https://www.kingsleague.pro/" target="_blank" class="text-blue-600 hover:underline">página oficial de la Kings League</a> 
    y los transforma en contenido visual e interactivo. Utilizamos técnicas de análisis estadístico avanzado, visualización de datos e inteligencia artificial para ofrecer una experiencia única y enriquecedora.
  </p>
  <p class="text-lg text-gray-500 mt-2">
    Ideal para entrenadores, analistas y fanáticos de la Kings League, esta herramienta permite explorar el rendimiento de los jugadores de forma profesional, intuitiva y entretenida.
  </p>

<ul class="list-disc list-inside text-lg text-gray-500 mt-2 space-y-2">
  <li>
    En <strong>'2023'</strong> se muestra información de los torneos de la <strong>Kings League</strong>, sobre el 1, 2 split, Kings Cup y Kingdom Cup.
  </li>
  <li>
    En <strong>'2024'</strong> se muestra información de los torneos de la <strong>Kings League</strong>, sobre el 4 y 5 split.
  </li>
  <li>
    En <strong>'Combinado'</strong> se muestra la información de todos los torneos de la <strong>Kings</strong>.
  </li>
  <li>
    En <strong>'Solo Splits'</strong> se muestra la información de todos los Splits de la <strong>Kings</strong>.
  </li>
</ul>

  <p class="text-lg text-gray-500 mt-2">
    Proximamente, se viene contenido muy Top!
  </p>
</div>


    <!-- Dashboard -->
    <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-2 gap-4 animate-fadeIn">
      <!-- Estado inicial -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
        <div class="p-8 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Estadísticas de MVP por Partido</h3>
          <p class="text-gray-500 mb-4">Visualiza los jugadores más valiosos por partido en diferentes temporadas y torneos</p>
          <div class="flex justify-center gap-3">
            <button onclick="loadYear('2023')" class="px-4 py-2 text-sm rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:shadow-lg transition-all duration-300">
              Cargar 2023
            </button>
            <button onclick="loadYear('combined')" class="px-4 py-2 text-sm rounded-lg bg-gradient-to-br from-green-500 to-green-600 text-white shadow-md hover:shadow-lg transition-all duration-300">
              Todos los torneos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 pt-8 border-t border-gray-200 text-center text-sm text-gray-600 bg-white">
      <h2 class="text-xl font-semibold mb-4">Acerca de este sitio</h2>
      <p class="max-w-xl mx-auto mb-4 px-4">
        <strong>Mercato Kings</strong> es una plataforma independiente diseñada para compartir datos, estadísticas y análisis relevantes sobre la <strong>Kings League</strong>, con fines exclusivamente informativos e identificativos.
      </p>
      <p class="text-xs">Datos estadísticos de la Kings League ©2025</p>
      <p class="mt-1 text-xs">Desarrollado con <span class="text-red-500">♥</span> para los fans del fútbol</p>
    </footer>
  </div>

  <script>
    // Configuración de archivos
    const fileSets = {
      "2023": [
        "../json/2023_2024/match_MVP/1_split_kings.csv",
        "../json/2023_2024/match_MVP/2_split_kings.csv",
        "../json/2023_2024/match_MVP/3_split_kings.csv",
      ],
      "2024": [
        "../json/2024_2025/match_MVP/4_split_kings.csv",
        "../json/2024_2025/match_MVP/5_split_kings.csv"
      ]
    };
    fileSets["combined"] = [...fileSets["2023"], ...fileSets["2024"]];
    fileSets["splits-only"] = fileSets["2023"].slice(0, 3).concat(fileSets["2024"]);

    // Limpiar nombres
    const cleanName = name => {
      if (!name || typeof name !== 'string') return ''; // Manejar valores undefined o no strings
      return name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    };

    // Procesar datos
    function processData(file, data) {
      return new Promise((resolve) => {
        const tournamentName = file.split('/').pop().replace('.csv', '').replace(/_/g, ' ');
        const players = {};

        data.forEach(row => {
          const name = cleanName(row["Name"]);
          if (!name) return;

          if (!players[name]) {
            players[name] = {
              name: row["Name"].trim(),
              team: row["Team"],
              pm: parseInt(row["PM"]) || 0,
              mvps: parseInt(row["MVP"]) || 0,
              tournaments: new Set([tournamentName])
            };
          } else {
            players[name].pm += parseInt(row["PM"]) || 0;
            players[name].mvps += parseInt(row["MVP"]) || 0;
            players[name].tournaments.add(tournamentName);
          }
        });

        resolve(Object.values(players));
      });
    }

    // Explicación del jugador
    function explainPlayer(p) {
      const efficiency = p.pm > 0 ? ((p.mvps / p.pm) * 100).toFixed(1) : 0;
      
      let html = `<div style="max-width: 500px;">`;
      html += `<strong>${p.name}</strong><br>`;
      html += `<strong>Equipo:</strong> ${p.team}<br>`;
      html += `<span class="mvp-badge">${p.mvps} MVP</span><br>`;
      html += `<strong>Partidos como MVP:</strong> ${p.pm}<br>`;
      html += `<strong>Eficiencia:</strong> ${efficiency}%<br><br>`;
      
      if (p.tournaments.length > 1) {
        html += `<u>Torneos:</u><br>`;
        html += `• ${Array.from(p.tournaments).join('<br>• ')}`;
      }

      html += `</div>`;
      return html;
    }

    // Mostrar datos en gráficos
    function drawMVPCharts(players) {
      // Ordenar jugadores por MVPs
      const sortedByMVPs = [...players].sort((a, b) => b.mvps - a.mvps || b.pm - a.pm);
      
      // Gráfico de barras - Top MVPs
      const topMVPs = sortedByMVPs.slice(0, 15);
      const mvpChartDiv = document.createElement("div");
      mvpChartDiv.className = "bg-white rounded shadow p-4";
      mvpChartDiv.style.height = "500px";
      document.getElementById("dashboard").appendChild(mvpChartDiv);
      
      const mvpChart = echarts.init(mvpChartDiv);
      mvpChart.setOption({
        title: { 
          text: 'Top 15 - Jugadores con más MVP', 
          left: 'center',
          textStyle: { fontSize: 16 }
        },
        tooltip: {
          formatter: params => {
            const player = players.find(p => p.name === params.name);
            return explainPlayer(player);
          }
        },
        xAxis: {
          type: 'category',
          data: topMVPs.map(p => p.name),
          axisLabel: {
            rotate: 30,
            interval: 0,
            fontSize: 10,
            formatter: value => value.length > 15 ? value.slice(0, 12) + '...' : value
          }
        },
        yAxis: { 
          type: 'value',
          name: 'Número de MVP'
        },
        series: [{
          data: topMVPs.map(p => p.mvps),
          type: 'bar',
          itemStyle: { color: '#FFD700' },
          emphasis: { itemStyle: { color: '#8E0303' } },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}'
          }
        }],
        grid: {
          left: '10%',
          right: '10%',
          bottom: '25%',
          top: '15%'
        }
      });

      // Gráfico de relación PM vs MVP
      const relationChartDiv = document.createElement("div");
      relationChartDiv.className = "bg-white rounded shadow p-4";
      relationChartDiv.style.height = "500px";
      document.getElementById("dashboard").appendChild(relationChartDiv);
      
      const relationChart = echarts.init(relationChartDiv);
      relationChart.setOption({
        title: { 
          text: 'Relación Partidos MVP vs Número de MVP', 
          left: 'center',
          textStyle: { fontSize: 16 }
        },
        tooltip: {
          formatter: params => {
            const player = players.find(p => p.name === params.data[2]);
            return explainPlayer(player);
          }
        },
        xAxis: {
          type: 'value',
          name: 'Partidos como MVP (PM)'
        },
        yAxis: {
          type: 'value',
          name: 'Número de MVP'
        },
        series: [{
          data: players.map(p => [p.pm, p.mvps, p.name]),
          type: 'scatter',
          symbolSize: function(data) {
            return Math.sqrt(data[1]) * 4 + 4;
          },
          itemStyle: {
            color: function(params) {
              const ratio = params.data[1] / (params.data[0] || 1);
              return ratio > 0.5 ? '#8E0303' : ratio > 0.3 ? '#FFA500' : '#FFD700';
            }
          },
          label: {
            show: true,
            formatter: function(params) {
              return params.data[1] >= 3 ? params.data[2].split(' ')[0] : '';
            },
            position: 'top',
            fontSize: 10
          }
        }],
        grid: {
          left: '15%',
          right: '10%',
          bottom: '15%',
          top: '15%'
        }
      });
    }

    // Predicción de rendimiento por IA
    async function predictPerformance(players) {
      const tfDiv = document.createElement("div");
      tfDiv.className = "bg-white rounded shadow p-4 col-span-2 ai-section";
      tfDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Predicción de Rendimiento por la Inteligencia Artificial</h3>';
      document.getElementById("dashboard").appendChild(tfDiv);

      try {
        await tf.ready();
        
        const filteredPlayers = players.filter(p => p.pm > 0);
        const features = filteredPlayers.map(p => [
          p.mvps / 10,
          p.pm / 20,
          (p.mvps / (p.pm || 1)) * 10
        ]);
        
        const labels = filteredPlayers.map(p => [
          (p.mvps * 2 + p.pm * 0.5) / 10
        ]);
        
        const xs = tf.tensor2d(features);
        const ys = tf.tensor2d(labels);
        
        const model = tf.sequential();
        model.add(tf.layers.dense({ units: 8, activation: 'relu', inputShape: [3] }));
        model.add(tf.layers.dense({ units: 4, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 1 }));
        
        model.compile({
          optimizer: tf.train.adam(0.01),
          loss: 'meanSquaredError'
        });

        await model.fit(xs, ys, {
          epochs: 30,
          batchSize: 8,
          shuffle: true,
        });
        
        const topPlayers = [...filteredPlayers].sort((a, b) => b.mvps - a.mvps).slice(0, 3);
        
        topPlayers.forEach(p => {
          const input = tf.tensor2d([[
            p.mvps / 5,
            p.pm / 10,
            (p.mvps / (p.pm || 1)) * 10
          ]]);
          
          const prediction = model.predict(input).dataSync()[0] * 10;
          const predictionElement = document.createElement("div");
          predictionElement.className = "mb-2 p-2 bg-blue-50 rounded";
          
          let interpretacion = "";
          if (prediction >= 20) {
            interpretacion = "🔥 MVP Excepcional";
          } else if (prediction >= 60) {
            interpretacion = "💪 MVP Destacado";
          } else if (prediction >= 40) {
            interpretacion = "⚙️ MVP Regular";
          } else if (prediction >= 20) {
            interpretacion = "⚠️ Por debajo de lo esperado";
          } else {
            interpretacion = "❌ Rendimiento bajo";
          }

          predictionElement.innerHTML = `
            <p><strong>${p.name}</strong>: Puntuación de rendimiento: ${prediction.toFixed(1)}/100</p>
            <p class="text-sm text-gray-700">${interpretacion}</p>
          `;
          tfDiv.appendChild(predictionElement);
        });
        
        const infoDiv = document.createElement("div");
        infoDiv.className = "text-sm text-gray-600 mt-4 p-2 bg-white rounded";
        infoDiv.innerHTML = `
          <p><strong>Nota:</strong> Este modelo predice el rendimiento futuro basado en:</p>
          <ul class="list-disc pl-5 mt-2">
            <li>Número de MVP obtenidos</li>
            <li>Partidos jugados como MVP</li>
            <li>Eficiencia (MVP por partido)</li>
          </ul>
          <p class="mt-2">Los resultados son aproximados y pueden variar en cada ejecución.</p>
        `;
        tfDiv.appendChild(infoDiv);
        
      } catch (error) {
        console.error("Error en TensorFlow:", error);
        tfDiv.innerHTML += '<p class="text-red-500">Error al procesar el modelo predictivo</p>';
      }
    }

    // Clasificación de tipos de jugadores con Brain.js
    function classifyPlayers(players) {
      const brainDiv = document.createElement("div");
      brainDiv.className = "bg-white rounded shadow p-4 col-span-2 ai-section";
      brainDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Análisis de Jugadores Aleatorios</h3>';
      document.getElementById("dashboard").appendChild(brainDiv);

      try {
        const net = new brain.NeuralNetwork();
        
        net.train(players.map(p => ({
          input: {
            mvps: p.mvps / 10,
            pm: p.pm / 20,
            efficiency: (p.mvps / (p.pm || 1)) * 5
          },
          output: {
            mvp: p.mvps > 3 ? 1 : 0,
            consistente: (p.pm > 5 && (p.mvps / p.pm) > 0.3) ? 1 : 0,
            emergente: (p.mvps > 0 && p.mvps <= 2) ? 1 : 0
          }
        })), {
          iterations: 2000,
          log: true,
          logPeriod: 100
        });

        const examplePlayers = [...players]
          .sort(() => 0.5 - Math.random())
          .slice(0, 5);
        
        examplePlayers.forEach(p => {
          const output = net.run({
            mvps: p.mvps / 10,
            pm: p.pm / 20,
            efficiency: (p.mvps / (p.pm || 1)) * 5
          });
          
          const playerType = output.mvp > 0.7 ? "MVP Estrella" :
                           output.consistente > 0.7 ? "MVP Consistente" :
                           output.emergente > 0.7 ? "MVP Emergente" : "MVP Ocasional";
          
          const playerElement = document.createElement("div");
          playerElement.className = "mb-2 p-2 bg-green-50 rounded";
          playerElement.innerHTML = `
            <p><strong>${p.name}</strong>: ${playerType}</p>
            <p class="text-sm text-gray-600">Probabilidades: 
              Estrella ${(output.mvp * 100).toFixed(1)}%, 
              Consistente ${(output.consistente * 100).toFixed(1)}%, 
              Emergente ${(output.emergente * 100).toFixed(1)}%
            </p>
          `;
          brainDiv.appendChild(playerElement);
        });
      } catch (error) {
        console.error("Error en Brain.js:", error);
        brainDiv.innerHTML += '<p class="text-red-500">Error al clasificar jugadores</p>';
      }
    }

    // Agrupación de jugadores por estilo
    function clusterPlayers(players) {
      const clusterDiv = document.createElement("div");
      clusterDiv.className = "bg-white rounded shadow p-4 col-span-2 ai-section";
      clusterDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Agrupación de Jugadores por Estilo</h3>';
      document.getElementById("dashboard").appendChild(clusterDiv);

      try {
        const filteredPlayers = players.filter(p => p.pm > 0);
        const data = filteredPlayers.map(p => ({
          name: p.name,
          features: [p.mvps, p.pm, (p.mvps / p.pm) * 10],
          total: p.mvps + p.pm
        }));

        // K-Means clustering simplificado
        const k = 3;
        const centroids = [];
        for (let i = 0; i < k; i++) {
          centroids.push(data[Math.floor(Math.random() * data.length)].features);
        }

        const clusteredData = data.map(d => {
          let minDist = Infinity;
          let cluster = 0;

          centroids.forEach((c, i) => {
            const dist = Math.sqrt(
              Math.pow(d.features[0] - c[0], 2) +
              Math.pow(d.features[1] - c[1], 2) +
              Math.pow(d.features[2] - c[2], 2)
            );
            if (dist < minDist) {
              minDist = dist;
              cluster = i;
            }
          });

          return { ...d, cluster };
        });

        // Mostrar resultados
        const clusterGroups = {};
        clusteredData.forEach(d => {
          if (!clusterGroups[d.cluster]) {
            clusterGroups[d.cluster] = [];
          }
          clusterGroups[d.cluster].push(d);
        });

        Object.entries(clusterGroups).forEach(([cluster, players]) => {
          const clusterElement = document.createElement("div");
          clusterElement.className = "mb-4 p-3 bg-gray-50 rounded";
          
          // Determinar tipo de cluster
          const avgMvps = players.reduce((sum, p) => sum + p.features[0], 0) / players.length;
          const avgPm = players.reduce((sum, p) => sum + p.features[1], 0) / players.length;
          const avgEff = players.reduce((sum, p) => sum + p.features[2], 0) / players.length;
          
          let clusterType = "";
          if (avgMvps > 3 && avgEff > 5) {
            clusterType = "MVP Estrellas";
          } else if (avgPm > 5 && avgEff > 3) {
            clusterType = "MVP Consistentes";
          } else {
            clusterType = "MVP Ocasionales";
          }

          clusterElement.innerHTML = `<h4 class="font-semibold mb-2">Grupo ${parseInt(cluster) + 1}: ${clusterType} (${players.length} jugadores)</h4>`;
          
          const topPlayers = [...players].sort((a, b) => b.total - a.total).slice(0, 5);
          topPlayers.forEach(p => {
            const playerElement = document.createElement("div");
            playerElement.className = "text-sm mb-1";
            playerElement.textContent = `${p.name}: ${p.features[0]} MVP (${p.features[1]} partidos)`;
            clusterElement.appendChild(playerElement);
          });
          
          clusterDiv.appendChild(clusterElement);
        });
      } catch (error) {
        console.error("Error en clustering:", error);
        clusterDiv.innerHTML += '<p class="text-red-500">Error al agrupar jugadores</p>';
      }
    }

    // Narrativa de torneos
    function generateStorytelling(players) {
      const storyDiv = document.createElement("div");
      storyDiv.className = "bg-white rounded shadow p-4 col-span-2 ai-section";
      storyDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Narrativa de los Torneos Analizada por la Inteligencia Artificial</h3>';
      document.getElementById("dashboard").appendChild(storyDiv);

      const topPlayers = [...players].sort((a, b) => b.mvps - a.mvps).slice(0, 3);
      const mostEfficient = [...players].filter(p => p.pm > 3)
        .sort((a, b) => (b.mvps / b.pm) - (a.mvps / a.pm))[0];
      
      let story = `<div class="prose max-w-none">`;
      story += `<p>En el análisis de los MVP de la Kings League, destacan:</p>`;
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">Los MVP más destacados</h4>`;
      topPlayers.forEach((p, i) => {
        story += `<p>${i+1}. <strong>${p.name}</strong> con ${p.mvps} MVP en ${p.pm} partidos `;
        story += `(${(p.mvps / p.pm * 100).toFixed(1)}% de eficiencia).</p>`;
      });
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">El MVP más eficiente</h4>`;
      story += `<p><strong>${mostEfficient.name}</strong> tiene la mejor eficiencia, `;
      story += `con ${mostEfficient.mvps} MVP en solo ${mostEfficient.pm} partidos `;
      story += `(${(mostEfficient.mvps / mostEfficient.pm * 100).toFixed(1)}% de efectividad).</p>`;
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">Estadísticas clave</h4>`;
      story += `<ul class="list-disc pl-5">`;
      story += `<li>Total de jugadores con al menos 1 MVP: ${players.filter(p => p.mvps > 0).length}</li>`;
      story += `<li>Promedio de MVP por jugador: ${(players.reduce((sum, p) => sum + p.mvps, 0) / players.length).toFixed(1)}</li>`;
      story += `<li>Eficiencia promedio: ${(players.filter(p => p.pm > 0).reduce((sum, p) => sum + (p.mvps / p.pm), 0) * 100 / players.filter(p => p.pm > 0).length).toFixed(1)}%</li>`;
      story += `</ul>`;
      
      story += `</div>`;
      
      storyDiv.innerHTML += story;
    }

    // Cargar datos
    let isLoading = false;
      
    function loadYear(year) {
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("dashboard").innerHTML = '';

      if (isLoading) return;
      isLoading = true;

      const files = fileSets[year];
      if (files.length === 0) {
        document.getElementById("loading").classList.add("hidden");
        isLoading = false;
        return;
      }

      const promises = files.map(file =>
        new Promise((resolve, reject) => {
          Papa.parse(file, {
            download: true,
            header: true,
            complete: results => {
              processData(file, results.data).then(resolve).catch(reject);
            },
            error: err => reject(err)
          });
        })
      );

      Promise.all(promises).then(results => {
        const mergedPlayers = {};
        
        results.flat().forEach(player => {
          const name = cleanName(player.name);
          if (!mergedPlayers[name]) {
            mergedPlayers[name] = {
              ...player,
              tournaments: new Set(player.tournaments)
            };
          } else {
            mergedPlayers[name].pm += player.pm;
            mergedPlayers[name].mvps += player.mvps;
            player.tournaments.forEach(t => mergedPlayers[name].tournaments.add(t));
          }
        });

        const playersArray = Object.values(mergedPlayers).map(p => ({
          ...p,
          tournaments: Array.from(p.tournaments)
        }));

        drawMVPCharts(playersArray);
        predictPerformance(playersArray);
        classifyPlayers(playersArray);
        clusterPlayers(playersArray);
        generateStorytelling(playersArray);

        document.getElementById("loading").classList.add("hidden");
        isLoading = false;
      }).catch(err => {
        console.error("Error procesando archivos:", err);
        document.getElementById("loading").classList.add("hidden");
        isLoading = false;
      });
    }

    // Cargar datos iniciales
    document.addEventListener("DOMContentLoaded", function() {
      if (fileSets && fileSets['2023']) {
        loadYear('2023');
      }
    });
  </script>
</body>
</html>
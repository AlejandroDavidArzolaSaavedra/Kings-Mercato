<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mercato Kings - Estadísticas</title>
  <meta name="description" content="Dashboard visual e interactivo con estadísticas avanzadas de la Kings League Mercato. Análisis por jugador, goles, penaltis, y más.">
  <meta name="keywords" content="Kings League, Mercato, estadísticas, goles, jugadores, penaltis, fútbol, visualización de datos">
  <meta name="author" content="Alejandro David Arzola Saavedra">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brain.js@2.0.0-beta.2/dist/brain-browser.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>

  <style>
    .card-tilted {
      transform: rotateX(75deg) translateY(-50px) translateZ(-50px);
      transition: transform 0.6s, box-shadow 0.6s;
      }
    .card-tilted:hover {
      transform: rotateX(0deg);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
     @keyframes shine {
    0% {
      transform: translateX(-100%) rotate(1deg);
    }
    100% {
      transform: translateX(100%) rotate(1deg);
    }
  }

  .shine-effect::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 150%;
    background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.6), transparent 70%);
    transform: translateX(-100%) rotate(12deg);
    animation: shine 2s linear infinite;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .card-tilted:hover .shine-effect::before {
    opacity: 1;
  }
  #tooltip {
  pointer-events: none;
  white-space: normal;
}
  </style>
<audio id="miAudio" src="./assets/goals.mp3"></audio>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header con logo y título -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
      <a href="./index.html">
      <div class="flex items-center gap-3">
          <img src="./assets/kingsIA.svg" alt="Logo Kings League" style="width: 6rem">
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r"  style="color: #8E0303;">
          Estadísticas de Goles <span class="block text-xl text-gray-600">Kings League Mercato</span>
        </h1>
      </div>
      </a>

  
      
      <div class="flex items-center gap-2">
        <div class="flex gap-2 flex-wrap justify-center">
          <button onclick="loadYear('2023')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            2023
          </button>
          <button onclick="loadYear('2024')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            2024
          </button>
          <button onclick="loadYear('combined')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Combinado
          </button>
          <button onclick="loadYear('splits-only')" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1"  style="background-color: #8E0303; font-weight: bold;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Solo Splits
          </button>
        </div>
      </div>
    </header>

    <!-- Loading spinner mejorado -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm">
      <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
        <div class="flex items-center gap-4 mb-4">
          <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
          <div>
            <p class="text-lg font-semibold text-gray-800">Procesando datos...</p>
            <p class="text-sm text-gray-500" id="loadingText">Cargando archivos de estadísticas</p>
          </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
        <div class="mt-2 flex justify-between text-xs text-gray-500">
          <span id="progressText">0%</span>
          <span id="fileCount">0/0 archivos</span>
        </div>
      </div>
    </div>


    <nav class="flex gap-2 flex-wrap justify-center mb-4">
  <a href="./goals.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
    Goles
  </a>
  <a href="./shots.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
    </svg>
    Tiros
  </a>
  <a href="./passing.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Pases
  </a>
  <a href="./offensives.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Ofensivas
  </a>
  <a href="./defensives.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Defensivas
  </a>
  <a href="./cards.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Tarjetas
  </a>
  <a href="./match_MVP.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    MVP Partido
  </a>
    <a href="./top_goal_keeper.html" class="px-4 py-2 rounded-lg text-white shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1" style="background-color: #8E0303; font-weight: bold;">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    Portero
  </a>
</nav>

    <!-- Añadimos imagen de portada-->
    <div class="relative w-full mb-8 cursor-pointer" onclick="document.getElementById('miAudio').play()" style="justify-content: center;">
      <img src="./assets/portada_goals.png" alt="Kings League" class="w-full h-112 rounded-lg shadow-lg">
      <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-50"></div>
      <h2 class="absolute top-4 left-4 text-white text-2xl font-bold">Estadísticas de Goles - Kings League Mercato</h2>
    </div>
<div class="mt-4 mb-8" style="display: inline-block;">
  <p class="text-lg text-gray-500">
    Esta plataforma recopila datos desde la 
    <a href="https://www.kingsleague.pro/" target="_blank" class="text-blue-600 hover:underline">página oficial de la Kings League</a> 
    y los transforma en contenido visual e interactivo. Utilizamos técnicas de análisis estadístico avanzado, visualización de datos e inteligencia artificial para ofrecer una experiencia única y enriquecedora.
  </p>
  <p class="text-lg text-gray-500 mt-2">
    Ideal para entrenadores, analistas y fanáticos de la Kings League, esta herramienta permite explorar el rendimiento de los jugadores de forma profesional, intuitiva y entretenida.
  </p>

<ul class="list-disc list-inside text-lg text-gray-500 mt-2 space-y-2">
  <li>
    En <strong>'2023'</strong> se muestra información de los torneos de la <strong>Kings League</strong>, sobre el 1, 2 split, Kings Cup y Kingdom Cup.
  </li>
  <li>
    En <strong>'2024'</strong> se muestra información de los torneos de la <strong>Kings League</strong>, sobre el 4 y 5 split.
  </li>
  <li>
    En <strong>'Combinado'</strong> se muestra la información de todos los torneos de la <strong>Kings</strong>.
  </li>
  <li>
    En <strong>'Solo Splits'</strong> se muestra la información de todos los Splits de la <strong>Kings</strong>.
  </li>
</ul>

  <p class="text-lg text-gray-500 mt-2">
    Proximamente, se viene contenido muy Top!
  </p>
</div>




      

    <!-- Dashboard con mejor espaciado -->
    <div id="dashboard" class="grid grid-cols-2 lg:grid-cols-2 gap-4 animate-fadeIn">
      <!-- Estado inicial (antes de cargar datos) -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
        <div class="p-8 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Selecciona una temporada</h3>
          <p class="text-gray-500 mb-4">Visualiza estadísticas detalladas de los jugadores en diferentes temporadas y torneos</p>
          <div class="flex justify-center gap-3">
            <button onclick="loadYear('2023')" class="px-4 py-2 text-sm rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md hover:shadow-lg transition-all duration-300">
              Cargar 2023
            </button>
            <button onclick="loadYear('combined')" class="px-4 py-2 text-sm rounded-lg bg-gradient-to-br from-green-500 to-green-600 text-white shadow-md hover:shadow-lg transition-all duration-300">
              Todos los torneos
            </button>
          </div>
        </div>
      </div>
    </div>

    

<script>
  const container = document.getElementById('carouselContainer');
  const scrollLeftBtn = document.getElementById('scrollLeft');
  const scrollRightBtn = document.getElementById('scrollRight');
  const cardWidth = 250 + 16; // 250px + 1rem (gap-4) ≈ 16px

  scrollLeftBtn.addEventListener('click', () => {
    container.scrollBy({ left: -cardWidth * 4, behavior: 'smooth' });
  });

  scrollRightBtn.addEventListener('click', () => {
    container.scrollBy({ left: cardWidth * 4, behavior: 'smooth' });
  });
</script>

    <!-- Footer -->
<footer class="mt-12 pt-8 border-t border-gray-200 text-center text-sm text-gray-600 bg-white">
  <h2 class="text-xl font-semibold mb-4">Acerca de este sitio</h2>
  <p class="max-w-xl mx-auto mb-4 px-4">
    <strong>Mercato Kings</strong> es una plataforma independiente diseñada para compartir datos, estadísticas y análisis relevantes sobre la <strong>Kings League</strong>, con fines exclusivamente informativos e identificativos.
  </p>

  <!-- Enlaces útiles -->
  <div class="flex justify-center flex-wrap gap-4 mb-6">
    <a href="https://www.kingsleague.pro/" target="_blank" class="hover:text-blue-600 transition">Página oficial</a>
    <a href="https://www.kingsleague.pro/faq" target="_blank" class="hover:text-blue-600 transition">FAQ</a>
    <a href="https://www.kingsleague.pro/contact" target="_blank" class="hover:text-blue-600 transition">Contacto</a>
  </div>

  <!-- Créditos -->
  <p class="mb-2 text-xs">
    Este proyecto utiliza la librería <a href="https://ml5js.org" target="_blank" class="text-blue-500 hover:underline">ml5.js</a>, una herramienta de código abierto desarrollada por la comunidad de NYU ITP/IMA y NYU Shanghai.
  </p>

  <p class="text-xs">Datos estadísticos de la Kings League ©2025</p>
  <p class="mt-1 text-xs">Desarrollado con <span class="text-red-500">♥</span> para los fans del fútbol</p>
</footer>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out;
    }
    /* Estilo para las tarjetas de gráficos que se generarán dinámicamente */
    #dashboard > div {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      border: 1px solid rgba(229, 231, 235, 0.8);
    }
    #dashboard > div:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(6, 8, 8, 0.466), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
  </style>
  <script>


    // 1. Normalización de nombres
    const cleanName = name => name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    // 2. Agregación temporal/por torneo mejorada
    const playerStats = {};
    const tournamentStats = {};

    const fileSets = {
      "2023": [
        "./json/2023_2024/goals/1_split_kings.csv",
        "./json/2023_2024/goals/2_split_kings.csv",
        "./json/2023_2024/goals/3_split_kings.csv",
        "./json/2023_2024/goals/kings_cup.csv",
        "./json/2023_2024/goals/kingdom_cup.csv"
      ],
      "2024": [
        "./json/2024_2025/goals/4_split_kings.csv",
        "./json/2024_2025/goals/5_split_kings.csv"
      ]
    };
    fileSets["combined"] = [...fileSets["2023"], ...fileSets["2024"]];
    fileSets["splits-only"] = fileSets["2023"].slice(0, 3).concat(fileSets["2024"]);



    // 5. Optimización del procesamiento con Web Worker (simulado)
    function processInChunks(data, chunkSize, callback) {
      const chunks = [];
      for (let i = 0; i < data.length; i += chunkSize) {
        chunks.push(data.slice(i, i + chunkSize));
      }
      
      let processed = 0;
      chunks.forEach((chunk, index) => {
        setTimeout(() => {
          callback(chunk);
          processed++;
          const progress = (processed / chunks.length) * 100;
          document.getElementById('progressBar').style.width = `${progress}%`;
        }, index * 50);
      });
    }
    const lista = [];
function processData(file, data) {
  return new Promise((resolve) => {
    const isSplit = file.includes("split");
    const tournamentName = file.split('/').pop().replace('.csv', '').replace(/_/g, ' ');

    if (!tournamentStats[tournamentName]) {
      tournamentStats[tournamentName] = {
        totalGoals: 0,
        players: new Set(),
        teams: new Set()
      };
    }

    const localPlayerStats = {};

    processInChunks(data, 100, (chunk) => {
      chunk.forEach(row => {
        const name = cleanName(row["Name"]), team = row["Team"];
        if (!name || !team) return;

        const goals = parseInt(row[isSplit ? "TG" : "G"]) || 0;
        const gx2 = parseInt(row["Gx2"]) || 0;
        const pen = parseInt(row["Pen"]) || 0;
        const pso = parseInt(row["PSO"]) || 0;
        const total = goals + gx2 + pen + pso;

        tournamentStats[tournamentName].totalGoals += total;
        tournamentStats[tournamentName].players.add(name);
        tournamentStats[tournamentName].teams.add(team);

        if (!localPlayerStats[name]) {
          localPlayerStats[name] = {
            name: row["Name"].trim(),
            teams: new Set(),
            totalGoals: 0,
            pen: 0,
            pso: 0,
            gx2: 0,
            matches: 0,
            timeline: []
          };
        }

        localPlayerStats[name].teams.add(team);
        localPlayerStats[name].totalGoals += goals;
        localPlayerStats[name].pen += pen;
        localPlayerStats[name].pso += pso;
        localPlayerStats[name].gx2 += gx2;
        localPlayerStats[name].matches += 1;
        localPlayerStats[name].timeline.push({
          torneo: tournamentName,
          goles: goals,
          penaltis: pen,
          dobles: gx2,
          pso: pso,
          total: total
        });
      });

      resolve(Object.values(localPlayerStats));
    });
  });
}


    // 6. Explicaciones automáticas por jugador
    function explainPlayer(p) {
  const total = p.totalGoals + p.gx2 + p.pen + p.pso || 1;
  const teams = Array.from(p.teams).join(", ");

  let html = `<div style="max-width: 500px;">`;
  html += `<strong>${p.name}</strong><br>`;
  html += `<strong>Equipos</strong><br>`;
  html += `(${teams})<br>`;
  html += `<strong>Total: ${total} goles </strong><br>`;
  html += `- ${p.totalGoals} normales (${((p.totalGoals / total) * 100).toFixed(1)}%)<br>`;
  html += `- ${p.gx2} dobles (${((p.gx2 / total) * 100).toFixed(1)}%)<br>`;
  html += `- ${p.pen} penaltis (${((p.pen / total) * 100).toFixed(1)}%)<br>`;
  html += `- ${p.pso} PSO (${((p.pso / total) * 100).toFixed(1)}%)<br><br>`;

  if (p.timeline.length > 1) {
    html += `<u>Torneos:</u><br>`;
    p.timeline.forEach(t => {
      html += `• ${t.torneo}: ${t.total} goles<br>`;
    });
  }

  html += `</div>`;
  return html;
}

    // 7. Visualizaciones de correlación
    function drawCorrelationCharts(players) {
      const scatterDiv = document.createElement("div");
      scatterDiv.className = "bg-white rounded shadow mb-4 col-span-2";
      scatterDiv.style.width = "100%";
      scatterDiv.style.maxWidth = "1200px";
      scatterDiv.style.margin = "0 auto"; // centra el gráfico si hay espacio
      scatterDiv.style.display = "grid"; // Necesario para justify-items
scatterDiv.style.justifyItems = "center"; // Centra los elementos hijos horizontalmente
      document.getElementById("dashboard").appendChild(scatterDiv);

      const chartDiv = document.createElement("div");
      chartDiv.style.width = "calc(10rem + 45vw)";
      chartDiv.style.height = "50vh";
      scatterDiv.appendChild(chartDiv);

      // ⚠️ Aquí es donde corregimos: renderizamos en chartDiv
      const trace = {
        x: players.map(p => p.totalGoals),
        y: players.map(p => p.gx2),
        mode: 'markers',
        type: 'scatter',
        text: players.map(p => p.name),
        marker: { size: 8 }
      };

      Plotly.newPlot(chartDiv, [trace], {
        title: 'Correlación entre Goles Normales y Goles Dobles',
        xaxis: { title: 'Goles Normales' },
        yaxis: { title: 'Goles Dobles (Gx2)' },
        margin: { t: 50 }
      });

      // ➕ Descripción debajo del gráfico
      const description = document.createElement("p");
      description.className = "text-lg text-gray-700 mt-4 p-4";
      description.innerText = "Este gráfico muestra cómo se relacionan los goles normales con los goles dobles (Gx2). Cada punto representa a un jugador. Una correlación positiva sugiere que quienes marcan más goles normales también tienden a marcar más goles dobles. Una correlación positiva significa que, cuando una variable aumenta, la otra también tiende a aumentar.";
      scatterDiv.appendChild(description);


      // Calcular correlaciones
      function correlation(a, b) {
        const n = a.length;
        const avgA = a.reduce((s, v) => s + v, 0) / n;
        const avgB = b.reduce((s, v) => s + v, 0) / n;
        const num = a.reduce((s, v, i) => s + ((v - avgA) * (b[i] - avgB)), 0);
        const den = Math.sqrt(
          a.reduce((s, v) => s + Math.pow(v - avgA, 2), 0) *
          b.reduce((s, v) => s + Math.pow(v - avgB, 2), 0)
        );
        return num / den;
      }

    }

    // 3. Modelos ML mejorados
    async function runAdvancedML(players) {
      // TensorFlow.js - Modelo más profundo
      const tfDiv = document.createElement("div");
      tfDiv.className = "bg-white rounded shadow p-4 col-span-2";
      tfDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Predicción de Rendimiento por la Inteligencia Artificial</h3>';
      document.getElementById("dashboard").appendChild(tfDiv);

      try {
        // Preparar datos
        await tf.ready();

        const filteredPlayers = players.filter(p => p.matches > 0);
        const features = filteredPlayers.map(p => [
          p.totalGoals / 100,
          p.pen / 20,
          p.pso / 10,
          p.gx2 / 20,
          p.matches / 50
        ]);
        
        const labels = filteredPlayers.map(p => [
          (p.totalGoals + p.gx2 * 2 + p.pen * 0.8 + p.pso * 0.5) / 50
        ]);
        const xs = tf.tensor2d(features);
        const ys = tf.tensor2d(labels);
        // Modelo
        const model = tf.sequential();
        model.add(tf.layers.dense({ units: 16, activation: 'relu', inputShape: [5] }));
        model.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        model.add(tf.layers.dense({ units: 1 }));
        model.compile({
          optimizer: tf.train.adam(0.01), // tasa de aprendizaje explícita
          loss: 'meanSquaredError'
        });

        await model.fit(xs, ys, {
          epochs: 30,
          batchSize: 8,
          shuffle: true,
        });
        // Predicción para jugadores destacados
        const topPlayers = [...filteredPlayers].sort((a, b) => b.totalGoals - a.totalGoals).slice(0, 3);
        topPlayers.forEach(p => {
          const input = tf.tensor2d([[
            p.totalGoals / 100,
            p.pen / 20,
            p.pso / 10,
            p.gx2 / 20,
            p.matches / 50
          ]]);
          
          const prediction = model.predict(input).dataSync()[0] * 50;
          const predictionElement = document.createElement("div");
          predictionElement.className = "mb-2 p-2 bg-blue-50 rounded";
// Interpretación corta según el valor
let interpretacion = "";
if (prediction >= 80) {
  interpretacion = "🔥 Jugador excepcional";
} else if (prediction >= 60) {
  interpretacion = "💪 Jugador destacado";
} else if (prediction >= 40) {
  interpretacion = "⚙️ Jugador promedio alto";
} else if (prediction >= 20) {
  interpretacion = "⚠️ Por debajo de lo esperado";
} else {
  interpretacion = "❌ Rendimiento muy bajo";
}

predictionElement.innerHTML = `
  <p><strong>${p.name}</strong>: Predicción de rendimiento: ${prediction.toFixed(1)} puntos</p>
  <p class="text-sm text-gray-700">${interpretacion}</p>
          `;
          tfDiv.appendChild(predictionElement);
        });
      } catch (error) {
        console.error("Error en TensorFlow:", error);
        tfDiv.innerHTML += '<p class="text-red-500">Error al procesar el modelo predictivo</p>';
      }
      let divElement = document.createElement("div");
      divElement.innerHTML = '<p class="text-sm text-gray-600 mb-4">Estos resultados son aproximados: la inteligencia artificial puede variar ligeramente en cada carga, pero ofrece predicciones muy similares. Su objetivo es ayudar a estimar el rendimiento ofensivo de cada jugador de forma objetiva. Cada rango indica la importancia y la calidad del jugador.<\p>';
      tfDiv.appendChild(divElement);
      
      let divElementText = document.createElement("div");
      divElementText.innerHTML = `
        <p class="text-sm text-gray-600 mb-4">
          Para predecir el rendimiento de los jugadores, se ajustan varias estadísticas clave a la misma escala de la siguiente manera:
        </p>
        <ul class="text-sm text-gray-600 mb-4">
          <li><strong>Goles (totalGoals):</strong> Se dividen entre 100 para evitar que un número elevado de goles influya de manera desproporcionada en el rendimiento.</li>
          <li><strong>Penales (pen):</strong> Se dividen entre 20, otorgándoles un peso menor en comparación con otras métricas.</li>
          <li><strong>Puntos de (pso):</strong> Se dividen entre 10 para asegurar que no tengan un impacto excesivo en la evaluación.</li>
          <li><strong>Goles x2 (gx2):</strong> Se dividen entre 20, representando goles decisivos o de mayor relevancia.</li>
          <li><strong>Partidos jugados (matches):</strong> Se dividen entre 50 para reflejar la experiencia del jugador, dándole más importancia a los partidos jugados en la Kings League.</li>
        </ul>
      `;

      tfDiv.appendChild(divElementText);


      // Brain.js - Clasificación de tipos de jugadores
      const brainDiv = document.createElement("div");
      brainDiv.className = "bg-white rounded shadow p-4 col-span-2";
      brainDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Analisis de jugadores aleatorios</h3>';
      document.getElementById("dashboard").appendChild(brainDiv);

      try {
        const net = new brain.NeuralNetwork();
        
        net.train(players.map(p => ({
          input: {
            goals: p.totalGoals / 100,
            pen: p.pen / 20,
            pso: p.pso / 10,
            gx2: p.gx2 / 20
          },
          output: {
            goleador: p.totalGoals > 10 ? 1 : 0,
            especialista: (p.pen > 3 || p.pso > 2) ? 1 : 0,
            versatil: (p.gx2 > 2 && p.totalGoals > 5) ? 1 : 0
          }
        })), {
          iterations: 2000, // Add a reasonable number of iterations
          log: true, // Enable logging for debugging
          logPeriod: 100 // Log every 100 iterations
        });

        // Ejemplos de clasificación
        const examplePlayers = [...players]
          .sort(() => 0.5 - Math.random())
          .slice(0, 5);
        
        examplePlayers.forEach(p => {
          const output = net.run({
            goals: p.totalGoals / 100,
            pen: p.pen / 20,
            pso: p.pso / 10,
            gx2: p.gx2 / 20
          });
          
          const playerType = output.goleador > 0.7 ? "Goleador" :
                           output.especialista > 0.7 ? "Especialista (penaltis/PSO)" :
                           output.versatil > 0.7 ? "Versátil (goles dobles)" : "Equilibrado";
          
          const playerElement = document.createElement("div");
          playerElement.className = "mb-2 p-2 bg-green-50 rounded";
          playerElement.innerHTML = `
            <p><strong>${p.name}</strong>: ${playerType}</p>
            <p class="text-sm text-gray-600">Probabilidades: 
              Goleador ${(output.goleador * 100).toFixed(1)}%, 
              Especialista ${(output.especialista * 100).toFixed(1)}%, 
              Versátil ${(output.versatil * 100).toFixed(1)}%
            </p>
          `;
          brainDiv.appendChild(playerElement);
        });
      } catch (error) {
        console.error("Error en Brain.js:", error);
        brainDiv.innerHTML += '<p class="text-red-500">Error al clasificar jugadores</p>';
      }
    }

    // 4. Clustering de jugadores
    function clusterPlayers(players) {
  const clusterDiv = document.createElement("div");
  clusterDiv.className = "bg-white rounded shadow p-4 col-span-2";
  clusterDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Agrupación de Jugadores por Estilo</h3>';
  document.getElementById("dashboard").appendChild(clusterDiv);

  try {
    // Preparar datos para clustering
    const data = players
      .filter(p => p.totalGoals + p.gx2 + p.pen + p.pso > 0)
      .map(p => ({
        name: p.name,
        features: [p.totalGoals, p.gx2 * 2, p.pen, p.pso],
        total: p.totalGoals + p.gx2 + p.pen + p.pso
      }));

    // Normalizar datos
    const maxValues = [0, 0, 0, 0];
    data.forEach(d => {
      d.features.forEach((f, i) => {
        if (f > maxValues[i]) maxValues[i] = f;
      });
    });

    const normalizedData = data.map(d => ({
      ...d,
      features: d.features.map((f, i) => f / (maxValues[i] || 1))
    }));

    // K-Means clustering (simplificado)
    const k = 3;
    const centroids = [];
    for (let i = 0; i < k; i++) {
      centroids.push(normalizedData[Math.floor(Math.random() * normalizedData.length)].features);
    }

    // Asignar clusters
    const clusteredData = normalizedData.map(d => {
      let minDist = Infinity;
      let cluster = 0;

      centroids.forEach((c, i) => {
        const dist = Math.sqrt(
          Math.pow(d.features[0] - c[0], 2) +
          Math.pow(d.features[1] - c[1], 2) +
          Math.pow(d.features[2] - c[2], 2) +
          Math.pow(d.features[3] - c[3], 2)
        );
        if (dist < minDist) {
          minDist = dist;
          cluster = i;
        }
      });

      return { ...d, cluster };
    });

    // Visualizar clusters
    const clusterGroups = {};
    clusteredData.forEach(d => {
      if (!clusterGroups[d.cluster]) {
        clusterGroups[d.cluster] = [];
      }
      clusterGroups[d.cluster].push(d);
    });

    Object.entries(clusterGroups).forEach(([cluster, players]) => {
      const clusterElement = document.createElement("div");
      clusterElement.className = "mb-4 p-3 bg-gray-50 rounded";
      clusterElement.innerHTML = `<h4 class="font-semibold mb-2">Grupo ${parseInt(cluster) + 1} (${players.length} jugadores)</h4>`;

      const sortedPlayers = [...players].sort((a, b) => b.total - a.total);
      const topPlayers = sortedPlayers.slice(0, 5);
      const restPlayers = sortedPlayers.slice(5);

      topPlayers.forEach(p => {
        const playerElement = document.createElement("div");
        playerElement.className = "text-sm mb-1";
        playerElement.textContent = `${p.name}: ${data.find(d => d.name === p.name).total} goles totales`;
        clusterElement.appendChild(playerElement);
      });

      if (restPlayers.length > 0) {
        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = "Ver más jugadores";
        toggleBtn.className = "text-blue-500 text-xs mt-2 hover:underline";
        toggleBtn.style.cursor = "pointer";

        const restContainer = document.createElement("div");
        restContainer.style.display = "none";

        restPlayers.forEach(p => {
          const playerElement = document.createElement("div");
          playerElement.className = "text-sm mb-1";
          playerElement.textContent = `${p.name}: ${data.find(d => d.name === p.name).total} goles totales`;
          restContainer.appendChild(playerElement);
        });

        toggleBtn.addEventListener("click", () => {
          const visible = restContainer.style.display === "block";
          restContainer.style.display = visible ? "none" : "block";
          toggleBtn.textContent = visible ? "Ver más jugadores" : "Ocultar jugadores";
        });

        clusterElement.appendChild(toggleBtn);
        clusterElement.appendChild(restContainer);
      }

      // Descripción del cluster
      const avgFeatures = [0, 0, 0, 0];
      players.forEach(p => {
        p.features.forEach((f, i) => {
          avgFeatures[i] += f * (maxValues[i] || 1);
        });
      });

      avgFeatures.forEach((f, i) => avgFeatures[i] = (f / players.length).toFixed(1));

      const descElement = document.createElement("div");
      descElement.className = "text-xs mt-2 p-2 bg-white rounded";
      descElement.innerHTML = `
        <p><strong>Perfil promedio:</strong></p>
        <p>Goles normales: ${avgFeatures[0]}</p>
        <p>Goles dobles: ${avgFeatures[1]}</p>
        <p>Penaltis: ${avgFeatures[2]}</p>
        <p>PSO: ${avgFeatures[3]}</p>
      `;
      clusterElement.appendChild(descElement);

      clusterDiv.appendChild(clusterElement);
    });
  } catch (error) {
    console.error("Error en clustering:", error);
    clusterDiv.innerHTML += '<p class="text-red-500">Error al agrupar jugadores</p>';
  }
}


    // BONUS: Storytelling automático
    function generateStorytelling(players, tournaments) {
      const storyDiv = document.createElement("div");
      storyDiv.className = "bg-white rounded shadow p-4 col-span-2";
      storyDiv.innerHTML = '<h3 class="text-lg font-semibold mb-2">Narrativa de los Torneos de la Kings analizada por la Inteligencia Artificial</h3>';
      document.getElementById("dashboard").appendChild(storyDiv);

      // Top goleadores
      const topScorers = [...players].sort((a, b) => 
        (b.totalGoals + b.gx2 + b.pen + b.pso) - (a.totalGoals + a.gx2 + a.pen + a.pso)
      ).slice(0, 3);

      // Torneo con más goles
      const topTournament = Object.entries(tournaments).sort((a, b) => b[1].totalGoals - a[1].totalGoals)[0];

      // Jugador más versátil (goles normales, dobles, penaltis y PSO)
      const mostVersatile = [...players].sort((a, b) => {
        const aScore = (a.totalGoals > 0 ? 1 : 0) + (a.gx2 > 0 ? 1 : 0) + (a.pen > 0 ? 1 : 0) + (a.pso > 0 ? 1 : 0);
        const bScore = (b.totalGoals > 0 ? 1 : 0) + (b.gx2 > 0 ? 1 : 0) + (b.pen > 0 ? 1 : 0) + (b.pso > 0 ? 1 : 0);
        return bScore - aScore || (b.totalGoals + b.gx2 + b.pen + b.pso) - (a.totalGoals + a.gx2 + a.pen + a.pso);
      })[0];

      // Construir la narrativa
      let story = `<div class="prose max-w-none">`;
      
      story += `<h4 class="font-semibold text-blue-800">Resumen de la Temporada</h4>`;
      story += `<p>En un emocionante torneo que contó con ${Object.keys(tournaments).length} competiciones distintas, `;
      story += `los jugadores demostraron su calidad goleadora con un total de ${Object.values(tournaments).reduce((sum, t) => sum + t.totalGoals, 0)} goles. `;
      story += `El torneo más productivo fue <strong>${topTournament[0]}</strong> con ${topTournament[1].totalGoals} goles.</p>`;
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">Los Goleadores Estrella</h4>`;
      topScorers.forEach((p, i) => {
        story += `<p>${i+1}. <strong>${p.name}</strong> lidera la tabla con un total de ${p.totalGoals + p.gx2 + p.pen + p.pso} goles: `;
        story += `${p.totalGoals} normales, ${p.gx2} dobles, ${p.pen} de penalti y ${p.pso} en PSO. `;
        story += `Un rendimiento destacado que incluye participación con ${Array.from(p.teams).join(" y ")}.</p>`;
      });
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">El Jugador Más Versátil</h4>`;
      story += `<p><strong>${mostVersatile.name}</strong> demostró ser el jugador más completo, `;
      story += `marcando goles de ${mostVersatile.totalGoals > 0 ? 'juego normal, ' : ''}${mostVersatile.gx2 > 0 ? 'doble, ' : ''}${mostVersatile.pen > 0 ? 'penalti, ' : ''}${mostVersatile.pso > 0 ? 'PSO' : ''}. `;
      story += `Una habilidad multifacética que lo convierte en un activo valioso para cualquier equipo.</p>`;
      
      story += `<h4 class="font-semibold text-blue-800 mt-4">Estadísticas Destacadas</h4>`;
      story += `<ul class="list-disc pl-5">`;
      story += `<li>Total de jugadores participantes: ${players.length}</li>`;
      story += `<li>Equipos representados: ${new Set(Object.values(tournaments).flatMap(t => Array.from(t.teams))).size}</li>`;
      story += `<li>Goles más comunes: normales (${players.reduce((sum, p) => sum + p.totalGoals, 0)})</li>`;
      story += `<li>Goles más decisivos: dobles (${players.reduce((sum, p) => sum + p.gx2, 0)})</li>`;
      story += `</ul>`;
      
      story += `</div>`;
      
      storyDiv.innerHTML += story;
    }


    let isLoading = false;
      
function loadYear(year) {
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("dashboard").innerHTML = '';

  if (isLoading) return;
  isLoading = true;

  // Limpiar completamente los objetos
  for (const key in playerStats) delete playerStats[key];
  for (const key in tournamentStats) delete tournamentStats[key];

  const files = fileSets[year];

  if (files.length === 0) {
    document.getElementById("loading").classList.add("hidden");
    isLoading = false;
    return;
  }

  const promises = files.map(file =>
    new Promise((resolve, reject) => {
      Papa.parse(file, {
        download: true,
        header: true,
        complete: results => {
          processData(file, results.data).then(resolve).catch(reject);
        },
        error: err => reject(err)
      });
    })
  );

  Promise.all(promises).then(results => {
    // Unificar todos los jugadores
    const mergedPlayers = {};

    results.flat().forEach(player => {
      const name = player.name;
      if (!mergedPlayers[name]) {
        mergedPlayers[name] = {
          ...player,
          teams: new Set(player.teams),
          timeline: [...player.timeline]
        };
      } else {
        mergedPlayers[name].totalGoals += player.totalGoals;
        mergedPlayers[name].pen += player.pen;
        mergedPlayers[name].pso += player.pso;
        mergedPlayers[name].gx2 += player.gx2;
        mergedPlayers[name].matches += player.matches;
        player.teams.forEach(t => mergedPlayers[name].teams.add(t));
        mergedPlayers[name].timeline.push(...player.timeline);
      }
    });

    const playersArray = Object.values(mergedPlayers).map(p => ({
      ...p,
      team: Array.from(p.teams).join(", "),
      total: p.totalGoals + p.gx2 + p.pen + p.pso
    }));


    drawBasicCharts(playersArray);
    // Aquí puedes añadir más funciones de análisis
    drawCorrelationCharts(playersArray);
    runAdvancedML(playersArray);
    clusterPlayers(playersArray);
    generateStorytelling(playersArray, tournamentStats);

    document.getElementById("loading").classList.add("hidden");
    isLoading = false;
  }).catch(err => {
    console.error("Error procesando archivos:", err);
    document.getElementById("loading").classList.add("hidden");
    isLoading = false;
  });
}
    function drawBasicCharts(players) {
      const categories = [
        { key: 'totalGoals', label: 'Goles Normales', color: '#60A5FA' },
        { key: 'gx2', label:'Goles Dobles (Gx2)', color: '#F59E0B' },
        { key: 'pen', label: 'Penaltis', color: '#10B981' },
        { key: 'pso', label: 'PSO', color: '#EC4899' },
        { key: 'total', label: 'Total Goleador', color: '#6366F1' }
      ];

      categories.forEach(cat => {
  const top = [...players].filter(p => p[cat.key] > 0).sort((a, b) => b[cat.key] - a[cat.key]).slice(0, 10);
  const chartDiv = document.createElement("div");
  chartDiv.className = "bg-white rounded shadow p-4";
  chartDiv.style.height = "400px";
  document.getElementById("dashboard").appendChild(chartDiv);
  
  const chart = echarts.init(chartDiv);
  chart.setOption({
    title: { text: `Top 10 - ${cat.label}`, left: 'center' },
    tooltip: {
      confine: true,  // Asegura que el tooltip se ajuste dentro de la pantalla
      formatter: params => {
        const player = players.find(p => p.name === params.name);
        return explainPlayer(player);
      }
    },
    xAxis: {
      type: 'category',
      data: top.map(p => p.name),
      axisLabel: {
        rotate: 30, // Rotación para que los nombres largos se ajusten mejor
        interval: 0, // Muestra todas las etiquetas, incluso si son largas
        formatter: function (value) {
          return value.length > 15 ? value.slice(0, 12) + '...' : value; // Limita los nombres a 12 caracteres con "..."
        },
        textStyle: {
          fontSize: 12,  // Ajusta el tamaño de la fuente
          lineHeight: 16 // Ajusta la altura de línea
        }
      }
    },
    yAxis: { type: 'value' },
    series: [{
      data: top.map(p => p[cat.key]),
      type: 'bar',
      itemStyle: { color: cat.color },
      emphasis: { itemStyle: { color: '#4CAF50' } }
    }],
    grid: {
      left: '10%',
      right: '10%',
      bottom: '25%' 
    }
  });
});

      // Gráfico de evolución por torneo para top jugadores
      const topPlayers = [...players].sort((a, b) => b.total - a.total).slice(0, 3);
      if (topPlayers.length > 0) {
        const timelineDiv = document.createElement("div");
        timelineDiv.className = "bg-white rounded shadow p-4";
        timelineDiv.style.height = "400px";
        document.getElementById("dashboard").appendChild(timelineDiv);
        
        const series = topPlayers.map(p => ({
          name: p.name,
          type: 'line',
          data: p.timeline.map(t => t.total),
          smooth: true
        }));
        
        echarts.init(timelineDiv).setOption({
          title: { text: 'Evolución por Torneo de la Kings (Top 3 Goleadores)', left: 'center' },
          tooltip: { trigger: 'axis' },
          legend: { data: topPlayers.map(p => p.name), top: 30 },
          xAxis: {
            type: 'category',
            data: topPlayers[0].timeline.map(t => t.torneo),
            axisLabel: { rotate: 30 }
          },
          yAxis: { type: 'value' },
          series: series
        });
      }
    }
    
document.addEventListener("DOMContentLoaded", function() {
  if (fileSets && fileSets['2023']) {
    loadYear('2023');
  } else {
    console.warn("fileSets['2023'] aún no está disponible.");
  }
});

  </script>
</body>
</html>